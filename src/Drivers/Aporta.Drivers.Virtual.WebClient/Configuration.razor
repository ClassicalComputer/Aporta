@using Blazorise.Snackbar
@using Newtonsoft.Json
@using Aporta.Shared.Calls
@using Aporta.Shared.Models
@using Aporta.Drivers.Virtual.Shared
@using Aporta.Drivers.Virtual.Shared.Actions
@* @using Microsoft.JSInterop; *@

@* @inject IJSRuntime JSRuntime; *@
@inject IDriverConfigurationCalls ConfigurationCalls;

@if (_configuration == null)
{
    <div class="spinner">Config Not Set</div>
}
else
{
    <Text>Setup</Text>


    <Table Narrow="true" Hoverable="true" ThemeContrast="ThemeContrast.Light">
        <TableHeader>
            <TableRow>
                <TableHeaderCell>Reader Name</TableHeaderCell>
                <TableHeaderCell>Reader Number</TableHeaderCell>
                <TableHeaderCell>Badge Number</TableHeaderCell>
                <TableHeaderCell></TableHeaderCell>
            </TableRow>
        </TableHeader>
        <TableBody>
            @foreach (var device in _configuration.Readers)
            {
                <TableRow ElementId="@("Device:" + @device.Name)">
                    <TableRowHeader>
                        @device.Name
                    </TableRowHeader>
                    <TableRowCell>
                        @device.Number
                    </TableRowCell>
                    <TableRowCell>
                        <TextEdit ElementId="@($"txtReaderNumber{device.Number}")"></TextEdit>
                    </TableRowCell>
                    <TableRowCell>
                        <Button Clicked="@(async () => await SwipeBadge(device.Number, "12345" ))">Click to Simulate Badge Swipe (12345 badge number currently hard coded)</Button>
                    </TableRowCell>
                </TableRow>
            }
        </TableBody>
    </Table>

    <Snackbar @ref="_snackbar" Color="@_snackbarColor">
        <SnackbarBody>
            @_snackbarMessage
        </SnackbarBody>
    </Snackbar>

    <MessageProvider />
}

@code {
    [Inject]
    IMessageService MessageService { get; set; }

    private Aporta.Drivers.Virtual.Shared.Configuration _configuration;

    private Snackbar _snackbar;
    private SnackbarColor _snackbarColor;
    private string _snackbarMessage = string.Empty;



    [Parameter]
    public Guid ExtensionId { get; set; }

    [Parameter]
    public string RawConfiguration { get; set; }

    protected override void OnParametersSet()
    {
        _configuration = JsonConvert.DeserializeObject<Aporta.Drivers.Virtual.Shared.Configuration>(RawConfiguration);
    }


    private async Task<string> SwipeBadge(byte readerNumber, string cardData)
    {

        //experiment to try to retrieve the value of the card number typed in by a user for a badge swipe...
        //var txtCardNumber = await JSRuntime.InvokeAsync<ElementReference>("document.getElementById", $"txtReaderNumber{readerNumber}");
        // cardData = txtCardNumber.value;

        var parameters = JsonConvert.SerializeObject(new BadgeSwipeAction
            {
                ReaderNumber = readerNumber,
                CardData = cardData
            });

        return await PerformAction(ActionType.BadgeSwipe, parameters);
    }

    private async Task<string> PerformAction(ActionType actionType, string parameters)
    {
        string responseData;
        try
        {
            responseData = await ConfigurationCalls.PerformAction(ExtensionId, actionType.ToString(), parameters);
        }
        catch (Exception exception)
        {
            _snackbarMessage = $"Unable to perform action {actionType.GetDescription()}. {exception.Message}";
            _snackbarColor = SnackbarColor.Danger;
            if (_snackbar != null) await _snackbar.Show();
            return string.Empty;
        }

        _snackbarMessage = $"Request to perform action {actionType.GetDescription()} successfully sent";
        _snackbarColor = SnackbarColor.Info;
        if (_snackbar != null) await _snackbar.Show();

        return responseData;
    }

}
