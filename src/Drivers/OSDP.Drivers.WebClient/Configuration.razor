@using System.Text.Json
@using System.Text

@using Aporta.Shared.Calls
@using OSDP.Drivers.Shared

@using OSDP.Drivers.Shared.Actions

@inject HttpClient Http

@if (_configuration == null)
    {
        <div class="spinner"></div>
    }
    else
    {

        <Row>
            <Column ColumnSize="ColumnSize.Is6.OnDesktop">
                @if (_addBus != null)
                {
                    <Button Clicked="_addPortModal.Show">Add RS-485 Port</Button>
                }
                else
                {
                    <Heading Size="HeadingSize.Is3">
                        No additional available ports
                    </Heading>
                }
            </Column>
        </Row>
        <Row>
            <Column>
                <Card Margin="Margin.Is4.OnY">
                    <CardTitle>

                    </CardTitle>
                    <CardBody>
                        <Accordion>
                            @foreach (var bus in _configuration.Buses)
                            {
                                <Collapse Visible="true">
                                    <CollapseHeader>
                                        <Heading Size="HeadingSize.Is5">
                                            Port @bus.PortName Devices
                                        </Heading>
                                        <Button Clicked="@(async () => await RemoveBus(bus.PortName))">
                                            Remove
                                        </Button>
                                        
                                        <Button Clicked="@(() =>ShowAddDeviceDialog(bus.PortName))">
                                            Add Device
                                        </Button>
                                    </CollapseHeader>
                                    <CollapseBody>
                                        <Table>
                                            <TableHeader>
                                                <TableRow>
                                                    <TableHeaderCell>Name</TableHeaderCell>
                                                    <TableHeaderCell>Address</TableHeaderCell>
                                                    <TableHeaderCell></TableHeaderCell>
                                                </TableRow>
                                            </TableHeader>
                                            <TableBody>
                                                @foreach (var device in bus.Devices)
                                                {
                                                    <TableRow>
                                                        <TableRowHeader>
                                                            @device.Name
                                                        </TableRowHeader>
                                                        <TableRowCell>
                                                            @device.Address
                                                        </TableRowCell>
                                                        <TableRowCell>
                                                            <Button Clicked="@(async () => await RemoveDevice(bus.PortName, device.Address))">
                                                                Remove
                                                            </Button>
                                                        </TableRowCell>
                                                    </TableRow>
                                                }
                                            </TableBody>
                                        </Table>
                                    </CollapseBody>
                                </Collapse>
                            }
                        </Accordion>
                    </CardBody>
                </Card>
            </Column>
        </Row>

        <Modal @ref="_addPortModal">
            <ModalBackdrop/>
            <ModalContent Size="ModalSize.Default" Centered="true">
                <ModalHeader>
                    <ModalTitle>
                        Add RS-485 Port
                    </ModalTitle>
                    <CloseButton Clicked="@_addPortModal.Hide"/>
                </ModalHeader>
                <ModalBody>
                    <Field>
                        <FieldLabel>Port</FieldLabel>
                        <FieldBody>
                            <Select TValue="string" @bind-SelectedValue="_addBus.PortName">
                                @foreach (var portName in _unusedPorts)
                                {
                                    <SelectItem Value=@portName>@portName</SelectItem>
                                }
                            </Select>
                        </FieldBody>
                    </Field>
                    <Field>
                        <FieldLabel>Baud Rate</FieldLabel>
                        <FieldBody>
                            <Select TValue="int" @bind-SelectedValue="_addBus.BaudRate">
                                @foreach (var baudRate in _baudRates)
                                {
                                    <SelectItem Value=@baudRate>@baudRate</SelectItem>
                                }
                            </Select>
                        </FieldBody>
                    </Field>
                </ModalBody>
                <ModalFooter>
                    <Button Color="Color.Secondary" Clicked="@_addPortModal.Hide">Close</Button>
                    <Button Color="Color.Primary" Clicked="@(async () => await AddBus())">Add</Button>
                </ModalFooter>
            </ModalContent>
        </Modal>

        <Modal @ref="_addDeviceModal">
            <ModalBackdrop/>
            <ModalContent Size="ModalSize.Default" Centered="true">
            <ModalHeader>
                        <ModalTitle>
                            Add Device to @_currentBus?.PortName
                        </ModalTitle>
                        <CloseButton Clicked="@_addDeviceModal.Hide"/>
                    </ModalHeader>
                    <ModalBody>
                        <Validations Mode="ValidationMode.Auto" ValidateOnLoad="false" @ref="_addDeviceValidations">
                            <Validation Validator="@ValidationRule.IsNotEmpty" >
                                <Field>
                                    <FieldLabel>Name</FieldLabel>
                                    <FieldBody>
                                        <TextEdit @bind-Text="_addDevice.Name">
                                            <Feedback>
                                                <ValidationError>
                                                    Please enter a name for the device
                                                </ValidationError>
                                            </Feedback>
                                        </TextEdit>
                                    </FieldBody>
                                </Field>
                            </Validation>
                            <Validation Validator="@ValidateDeviceAddress">
                                <Field>
                                    <FieldLabel>Address</FieldLabel>
                                    <FieldBody>
                                        <NumericEdit @bind-Value="_addDevice.Address" TValue="byte" Decimals="0">
                                            <ValidationError>
                                                Address already used by a device
                                            </ValidationError>
                                        </NumericEdit>
                                    </FieldBody>
                                </Field>
                            </Validation>
                        </Validations>
                    </ModalBody>
                    <ModalFooter>
                        <Button Color="Color.Secondary" Clicked="@_addDeviceModal.Hide">Close</Button>
                        <Button Color="Color.Primary" Clicked="@(async () => await AddDevice())">Add</Button>
                    </ModalFooter>
 
            </ModalContent>
        </Modal>
    }

@code {
    private Bus _addBus;
    private Bus _currentBus;
    private Device _addDevice;
    private IEnumerable<string> _unusedPorts;
    
    private Modal _addPortModal;
    private Modal _addDeviceModal;
    private Validations _addDeviceValidations;
    
    private readonly IEnumerable<int> _baudRates = new[]
    {
        9600,
        19200,
        38400,
        115200
    };

    private Shared.Actions.Configuration _configuration;
    
    [Parameter]
    public Guid ExtensionId { get; set; }

    [Parameter]
    public EventCallback<Guid> ExtensionIdChanged { get; set; }

    [Parameter]
    public string RawConfiguration { get; set; }

    [Parameter]
    public EventCallback<string> RawConfigurationChanged { get; set; }

    protected override void OnParametersSet()
    {
        _configuration = JsonSerializer.Deserialize<Shared.Actions.Configuration>(RawConfiguration);

        _addDevice = new Device{Name = string.Empty, Address = 0};
        
        InitializeNewBus();
    }  

    private void InitializeNewBus()
    {
        _unusedPorts = _configuration.AvailablePorts.Except(_configuration.Buses.Select(bus => bus.PortName));

        var unusedPorts = _unusedPorts as string[] ?? _unusedPorts.ToArray();
        if (unusedPorts.Any())
        {
            _addBus = new Bus
            {
                Devices = new List<Device>(),
                PortName = unusedPorts.First(),
                BaudRate = 9600
            };
        }
        else
        {
            _addBus = null;
        }
    }

    private async Task AddBus()
    {
        _addPortModal.Hide();
        
        await PerformAction(ActionType.AddBus.ToString(),
            JsonSerializer.Serialize(new BusAction
            {
                Bus = _addBus
            }));
    }

    private async Task RemoveBus(string busPortName)
    {
        var matchingBus = _configuration.Buses.First(bus => bus.PortName == busPortName);
        
        await PerformAction(ActionType.RemoveBus.ToString(),
            JsonSerializer.Serialize(new BusAction
            {
                Bus = matchingBus
            }));
    }

    private void ShowAddDeviceDialog(string portName)
    {
        _currentBus = _configuration.Buses.First(bus => bus.PortName == portName);
        _addDevice = new Device{Name = string.Empty, Address = 0};
        
        _addDeviceModal.Show();
    }

    private async Task AddDevice()
    {
        if (!_addDeviceValidations.ValidateAll())
        {
            return;
        }
        
        _addDeviceModal.Hide();

        await PerformAction(ActionType.AddUpdateDevice.ToString(),
            JsonSerializer.Serialize(new DeviceAction
            {
                PortName = _currentBus.PortName,
                Device = _addDevice
            }));
    }

    private async Task RemoveDevice(string portName, byte address)
    {
        _currentBus = _configuration.Buses.First(bus => bus.PortName == portName);

        var removingDevice = _currentBus.Devices.First(device => device.Address == address);

        await PerformAction(ActionType.RemoveDevice.ToString(),
            JsonSerializer.Serialize(new DeviceAction
            {
                PortName = _currentBus.PortName,
                Device = removingDevice
            }));
    }
    
    private async Task PerformAction(string actionType, string parameters)
    {
        string url = string.Format(Paths.ExtensionPerformAction, ExtensionId, actionType);
        var response = await Http.PostAsync(url,
            new StringContent(parameters, Encoding.UTF8, "application/json"));
        if (!response.IsSuccessStatusCode)
        {
            throw new Exception($"Unable to perform action. Response reason - {(int) response.StatusCode}:{response.ReasonPhrase}");
        }
    }

    private void ValidateDeviceAddress(ValidatorEventArgs eventArgs)
    {
        byte address = Convert.ToByte(eventArgs.Value);
        eventArgs.Status = _currentBus.Devices.All(device => device.Address != address) ? ValidationStatus.Success : ValidationStatus.Error;
    }

}