@page "/monitoring"

@using Aporta.Shared.Models
@using Aporta.Shared.Calls

@inject HttpClient Http

<Heading Size="HeadingSize.Is1">Monitoring</Heading>

@if (_outputs == null)
{
    <div class="spinner"></div>
}
else
{
<Row>
    <Column ColumnSize="ColumnSize.IsHalf">
        <Card Margin="Margin.Is4.OnY">
            <CardTitle Margin="Margin.Is4.OnX">
                Outputs
            </CardTitle>
            <CardBody>
                <Table Striped="true" Narrow="true" ThemeContrast="ThemeContrast.Light">
                    <TableHeader>
                        <TableRow>
                            <TableHeaderCell>Name</TableHeaderCell>
                            <TableHeaderCell></TableHeaderCell>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        @foreach (var output in _outputs.OrderBy(output => output.Name))
                        {
                            <TableRow>
                                <TableRowHeader>
                                    @output.Name
                                </TableRowHeader>
                                <TableRowCell>
                                    <Check TValue="bool" CheckedChanged="async (bool checkedValue) => await SetOutput(output.Id, checkedValue)" /> 
                                </TableRowCell>
                            </TableRow>
                        }
                    </TableBody>
                </Table>
            </CardBody>
        </Card>
    </Column> 
</Row>
}

<Snackbar @ref="_snackbar" Color="@_snackbarColor">
    <SnackbarBody>
        @_snackbarMessage
    </SnackbarBody>
</Snackbar>

@code {
    private Output[] _outputs;
    
    private Snackbar _snackbar;
    private SnackbarColor _snackbarColor;
    private string _snackbarMessage = string.Empty;
    
    protected override async Task OnInitializedAsync()
    {
        _outputs = await Http.GetFromJsonAsync<Output[]>(Paths.Outputs);
    }
    
    async Task SetOutput(int outputId, bool checkedValue)
    {
        string url = $"{Paths.Outputs}/set/{outputId}";
        url = QueryHelpers.AddQueryString(url, "state", checkedValue.ToString());
        var response = await Http.PostAsync(url, new StringContent(string.Empty));
        if (!response.IsSuccessStatusCode)
        {
            _snackbarMessage = "Unable to set output";
            _snackbarColor = SnackbarColor.Danger;
            _snackbar.Show();
        }
    }
}