@page "/configuration/drivers"

@using System.Dynamic

@using Aporta.Shared.Calls
@using Aporta.Shared.Messaging
@using Aporta.Shared.Models
@using Aporta.WebClient.Messaging

@inject HttpClient Http
@inject NavigationManager NavigationManager

@inject IHubProxyFactory HubConnectionBuilder;
@inject IExtensionCalls ExtensionCalls;

@implements IAsyncDisposable

<Heading Size="HeadingSize.Is1">Drivers</Heading>
<Divider />

@if (_extensions == null)
{
    <div class="spinner"></div>
}
else
{
    <Table Striped="true" Narrow="true" Hoverable="true" ThemeContrast="ThemeContrast.Light">
        <TableHeader>
            <TableRow>
                <TableHeaderCell>Name</TableHeaderCell>
                <TableHeaderCell>Enabled</TableHeaderCell>
                <TableHeaderCell>Loaded</TableHeaderCell>
            </TableRow>
        </TableHeader>
        <TableBody>
        @foreach (var extension in _extensions.OrderBy(extension => extension.Name))
        {
            <TableRow>
                <TableRowHeader>
                    <a href="configuration/driver/@extension.Id">
                        @extension.Name
                    </a>
                </TableRowHeader>
                <TableRowCell>
                    <Check TValue="bool" Checked="@extension.Enabled" CheckedChanged="async checkedValue => { await ExtensionEnabledChanged(extension.Id, checkedValue); }"/>
                </TableRowCell>
                <TableRowCell>
                    @if (extension.Loaded)
                    {
                        <Icon Name="IconName.Check" Style="color: green"/>
                    }
                    else
                    {
                        <Icon Name="IconName.MinusCircle" Style="color: red"/>
                    }
                </TableRowCell>
            </TableRow>
        }
        </TableBody>
    </Table>
}

<Snackbar @ref="_snackbar" Color="@_snackbarColor"> 
    <SnackbarBody>
        @_snackbarMessage
    </SnackbarBody>
</Snackbar>

@code {
    private IEnumerable<Extension> _extensions;
    private IHubProxy _hubConnection;

    private Snackbar _snackbar;
    private SnackbarColor _snackbarColor;
    private string _snackbarMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _hubConnection = HubConnectionBuilder.Create(NavigationManager.ToAbsoluteUri(Locations.DataChangeNotification));
        _hubConnection.On<Guid>(Methods.ExtensionDataChanged, async _ =>
        {
            await LoadExtensions();

            StateHasChanged();
        });
        await _hubConnection.StartAsync();

        await LoadExtensions();
    }

    async Task LoadExtensions()
    {
        try
        {
            _extensions = await ExtensionCalls.GetAll();
        }
        catch (Exception exception)
        {
            _extensions = new Extension[] { };
            _snackbarMessage = $"Load error. {exception.Message}";
            _snackbarColor = SnackbarColor.Danger;
            if (_snackbar != null) await _snackbar.Show();
        }
    }

    async Task ExtensionEnabledChanged(Guid extensionId, bool checkedValue)
    {
        string url = $"{Paths.Extensions}/{extensionId}";
        url = QueryHelpers.AddQueryString(url, "enabled", checkedValue.ToString());
        var response = await Http.PostAsync(url, new StringContent(string.Empty));
        if (!response.IsSuccessStatusCode)
        {
            dynamic content = await response.Content.ReadFromJsonAsync<ExpandoObject>();
            _snackbarMessage = content.detail.ToString();
            _snackbarColor = SnackbarColor.Danger;
            if (_snackbar != null) await _snackbar.Show();
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_hubConnection != null)
            {
                try { await _hubConnection.StopAsync(); }
                finally
                {
                    await _hubConnection.DisposeAsync();
                }
            }
        }
        catch
        {
            // ignored
        }
    }
}